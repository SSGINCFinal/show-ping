<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>Í≥µÌÜµ Î†àÏù¥ÏïÑÏõÉ</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script defer src="/js/scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const accessToken = sessionStorage.getItem("accessToken"); // ‚úÖ Access Token Í∞ÄÏ†∏Ïò§Í∏∞
            const userMenu = document.getElementById("user-menu");
            const loginButton = document.getElementById("login-button");
            const logoutButton = document.querySelector(".logout-button");

            if (accessToken) {
                // ‚úÖ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏöîÏ≤≠ÌïòÏó¨ ÌëúÏãú
                fetch("/api/auth/user-info", {
                    method: "GET",
                    headers: { Authorization: `Bearer ${accessToken}` }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.username) {
                            document.getElementById("user-greeting").innerText = `ÌôòÏòÅÌï©ÎãàÎã§, ${data.username}Îãò`;
                            if (userMenu) userMenu.style.display = "block";
                            if (loginButton) loginButton.style.display = "none";
                        }
                    })
                    .catch(error => {
                        console.log("‚ùå Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", error);
                        sessionStorage.removeItem("accessToken"); // Î°úÍ∑∏Ïù∏ Ïã§Ìå® Ïãú ÌÜ†ÌÅ∞ ÏÇ≠Ï†ú
                        if (userMenu) userMenu.style.display = "none";
                        if (loginButton) loginButton.style.display = "block";
                    });
            } else {
                // ‚úÖ ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú
                if (userMenu) userMenu.style.display = "none";
                if (loginButton) loginButton.style.display = "block";
            }

            // ‚úÖ Î°úÍ∑∏ÏïÑÏõÉ Í∏∞Îä•
            if (logoutButton) {
                logoutButton.addEventListener("click", function (event) {
                    event.preventDefault(); // Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ

                    fetch("/api/auth/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        credentials: "include" // Ïø†ÌÇ§ Ìè¨Ìï®
                    })
                        .then(() => {
                            sessionStorage.removeItem("accessToken"); // ‚úÖ ÌÜ†ÌÅ∞ ÏÇ≠Ï†ú
                            sessionStorage.removeItem("refreshToken");
                            alert("Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å!");
                            window.location.href = "/login"; // ‚úÖ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                        })
                        .catch(error => console.error("üö® Î°úÍ∑∏ÏïÑÏõÉ Ïò§Î•ò:", error));
                });
            }
        });
    </script>
</head>
<body>
<!-- Í≥µÌÜµ Ìó§Îçî -->
<header class="navbar">
    <div class="navbar-container">
        <!-- Î°úÍ≥† -->
        <div class="navbar-logo">
            <a href="/" style="color: #38A7FF">ShowPing</a>
        </div>

        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î©îÎâ¥ -->
        <nav class="navbar-menu">
            <ul class="menu-list">
                <li class="menu-item dropdown">
                    <a>Ïπ¥ÌÖåÍ≥†Î¶¨</a>
                    <!-- ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ -->
                    <ul class="dropdown-menu">
                        <li class="menu-item dropdown">
                            <ul class="dropdown-menu">
                                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Î¶¨Ïä§Ìä∏ ÎèôÏ†Å Ï∂îÍ∞Ä -->
                                <li></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="menu-item dropdown">
                    <a th:href="@{/stream/list}">ÎùºÏù¥Î∏å</a>
                </li>
                <li class="menu-item dropdown">
                    <a href="/tv-schedule">TV Ìé∏ÏÑ±Ìëú</a>
                </li>
                <li class="menu-item dropdown">
                    <a href="/events">Ïù¥Î≤§Ìä∏</a>
                </li>
            </ul>
        </nav>

        <!-- Í≤ÄÏÉâ Î∞è ÏÇ¨Ïö©Ïûê Î©îÎâ¥ -->
        <div class="navbar-right">
            <div class="cart-bar">
                <a href="/cart">
                    <img src="/img/cart.png" style="height: 20px">
                </a>
            </div>

            <!-- ‚úÖ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú -->
            <div id="user-menu" class="user-menu" style="display: none;">
                <span id="user-greeting"></span>
                <button class="logout-button">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>

            <!-- ‚úÖ ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú -->
            <a href="/login" id="login-button" class="login-button">Î°úÍ∑∏Ïù∏</a>
        </div>
    </div>
</header>

<!-- ÌéòÏù¥ÏßÄ ÎÇ¥Ïö© -->
<div class="main-content">
    <main layout:fragment="content"></main>
</div>

<button id="scrollToTop" class="scroll-to-top">‚ñ≤</button>

<!-- Í≥µÌÜµ Ìë∏ÌÑ∞ -->
<footer class="footer">
    <div class="footer-bottom">
        <p>&copy; 2025 Ïã†ÏÑ∏Í≥Ñ I&C. All rights reserved.</p>
        <div class="social-icons">
            <a href="/#">Facebook</a>
            <a href="/#">Twitter</a>
            <a href="/#">LinkedIn</a>
        </div>
    </div>
</footer>
</body>
</html>
