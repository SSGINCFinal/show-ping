<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>공통 레이아웃</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script defer src="/js/scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const accessToken = sessionStorage.getItem("accessToken"); // ✅ Access Token 가져오기
            const userMenu = document.getElementById("user-menu");
            const loginButton = document.getElementById("login-button");
            const logoutButton = document.querySelector(".logout-button");

            if (accessToken) {
                // ✅ 로그인 상태: 사용자 정보 요청하여 표시
                fetch("/api/auth/user-info", {
                    method: "GET",
                    headers: { Authorization: `Bearer ${accessToken}` }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.username) {
                            document.getElementById("user-greeting").innerText = `환영합니다, ${data.username}님`;
                            if (userMenu) userMenu.style.display = "block";
                            if (loginButton) loginButton.style.display = "none";
                        }
                    })
                    .catch(error => {
                        console.log("❌ 로그인 정보 불러오기 실패:", error);
                        sessionStorage.removeItem("accessToken"); // 로그인 실패 시 토큰 삭제
                        if (userMenu) userMenu.style.display = "none";
                        if (loginButton) loginButton.style.display = "block";
                    });
            } else {
                // ✅ 비로그인 상태
                if (userMenu) userMenu.style.display = "none";
                if (loginButton) loginButton.style.display = "block";
            }

            if (logoutButton) {
                console.log("로그아웃 버튼이 제대로 선택됨")
                logoutButton.addEventListener("click", function (event) {
                    event.preventDefault(); // 기본 링크 동작 방지

                    console.log("🚀 로그아웃 버튼 클릭됨 API 요청 실행");

                    fetch("/api/auth/logout", {  // ✅ 올바른 URL
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${sessionStorage.getItem("accessToken")}`,
                            "Content-Type": "application/json"
                        },
                        credentials: "include" // 쿠키를 포함하여 요청
                    })
                        .then(response => {
                            console.log("✅ 로그아웃 요청 완료, 응답 상태 코드:", response.status);
                            if (response.ok) {
                                sessionStorage.removeItem("accessToken"); // ✅ Access Token 삭제
                                sessionStorage.removeItem("refreshToken"); // ✅ Refresh Token 삭제
                                console.log("✅ 세션 토큰 삭제 완료");
                                window.location.href = "/login"; // ✅ 로그인 페이지로 이동
                            } else {
                                console.error("🚨 로그아웃 실패: ", response.statusText);
                            }
                        })
                        .catch(error => console.error("🚨 로그아웃 오류:", error));
                });
            }else {
                console.log("로그아웃 버튼을 찾을 수 없음")
            }
        });
    </script>
</head>
<body>
<!-- 공통 헤더 -->
<header class="navbar">
    <div class="navbar-container">
        <!-- 로고 -->
        <div class="navbar-logo">
            <a href="/" style="color: #38A7FF">ShowPing</a>
        </div>

        <!-- 네비게이션 메뉴 -->
        <nav class="navbar-menu">
            <ul class="menu-list">
                <li class="menu-item dropdown">
                    <a>카테고리</a>
                    <!-- 드롭다운 메뉴 -->
                    <ul class="dropdown-menu">
                        <li class="menu-item dropdown">
                            <ul class="dropdown-menu">
                                <!-- 카테고리 리스트 동적 추가 -->
                                <li></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="menu-item dropdown">
                    <a th:href="@{/stream/list}">라이브</a>
                </li>
                <li class="menu-item dropdown">
                    <a href="/tv-schedule">TV 편성표</a>
                </li>
                <li class="menu-item dropdown">
                    <a href="/events">이벤트</a>
                </li>
            </ul>
        </nav>

        <!-- 검색 및 사용자 메뉴 -->
        <div class="navbar-right">
            <div class="cart-bar">
                <a href="/cart">
                    <img src="/img/cart.png" style="height: 20px">
                </a>
            </div>

            <!-- ✅ 로그인 상태 -->
            <div id="user-menu" class="user-menu" style="display: none;">
                <span id="user-greeting"></span>
                <button class="logout-button">로그아웃</button>
            </div>

            <!-- ✅ 비로그인 상태 -->
            <a href="/login" id="login-button" class="login-button">로그인</a>
        </div>
    </div>
</header>

<!-- 페이지 내용 -->
<div class="main-content">
    <main layout:fragment="content"></main>
</div>

<button id="scrollToTop" class="scroll-to-top">▲</button>

<!-- 공통 푸터 -->
<footer class="footer">
    <div class="footer-bottom">
        <p>&copy; 2025 신세계 I&C. All rights reserved.</p>
        <div class="social-icons">
            <a href="/#">Facebook</a>
            <a href="/#">Twitter</a>
            <a href="/#">LinkedIn</a>
        </div>
    </div>
</footer>
</body>
</html>
