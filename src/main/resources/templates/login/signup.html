<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowPing 회원가입</title>
    <link rel="stylesheet" href="/css/login/signup.css">
    <script src="/js/jwt.js"></script>
</head>
<body>
<div class="container">
    <div class="logo-area">
        <h1>ShowPing!</h1>
        <div class="logo">S</div>
    </div>
    <div class="signup-form">
        <h2>회원가입</h2>

        <input type="text" placeholder="이름" id="name">

        <div class="input-group">
            <input type="email" placeholder="이메일" id="email">
            <button class="verify-btn">인증 코드 보내기</button>
        </div>

        <div class="input-group" id="email-verify-section">
            <input type="text" placeholder="인증 코드 입력" id="email-code">
            <button class="verify-code-btn">확인</button>
        </div>

        <form id="signup-form" onsubmit="return false;">
            <div class="input-group">
                <input type="text" placeholder="아이디" id="memberId" name="memberId">
                <button class="button" onclick="checkDuplicate()">중복 확인</button>
            </div>
        </form>

        <div class="input-group">
            <input type="password" id="password" placeholder="비밀번호">
            <button type="button" class="toggle-password">👁</button>
        </div>

        <div class="input-group">
            <input type="password" id="confirm-password" placeholder="비밀번호 확인">
            <button type="button" class="toggle-password">👁</button>
        </div>

        <div>
            <button type="button" class="check-password-btn">비밀번호 확인</button>
        </div>

        <div class="input-group">
            <input type="text" placeholder="주소" id="address">
            <button type="button" class="find-address-btn">주소 검색</button>
        </div>

        <!-- 전화번호 입력 -->
        <div class="input-group">
            <input type="text" placeholder="전화번호" id="phone">
        </div>

        <button type="submit" class="signup-btn">가입하기</button>
    </div>
</div>

<script>
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function () {
            const input = this.previousElementSibling;
            if (input.type === "password") {
                input.type = "text";
                this.textContent = "🔒";
            } else {
                input.type = "password";
                this.textContent = "👁";
            }
        });
    });


    document.querySelector('.verify-code-btn').addEventListener('click', function () {
        const email = document.getElementById('email').value;
        const emailCode = document.getElementById('email-code').value;

        fetch(`/signup/verify-code?email=${encodeURIComponent(email)}&code=${encodeURIComponent(emailCode)}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(isValid => {
                if (isValid) {
                    alert("이메일 인증 완료!");
                } else {
                    alert("인증 코드가 일치하지 않습니다.");
                }
            })
            .catch(error => {
                console.error("오류 발생:", error);
                alert("인증 코드 확인 실패");
            });
    });

    document.querySelector('.check-password-btn').addEventListener('click', function () {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (password === confirmPassword) {
            alert("비밀번호가 일치합니다.");
        } else {
            alert("비밀번호가 일치하지 않습니다.");
        }
    });

    document.querySelector('.signup-btn').addEventListener('click', function () {
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const emailCode = document.getElementById('email-code').value.trim();
        const memberId = document.getElementById('memberId').value.trim();
        const password = document.getElementById('password').value.trim();
        const confirmPassword = document.getElementById('confirm-password').value.trim();
        const address = document.getElementById('address').value.trim();
        const phone = document.getElementById('phone').value.trim();

        if (!name) {
            alert("이름을 입력해주세요.");
            return;
        }
        if (!email) {
            alert("이메일을 입력해주세요.");
            return;
        }
        if (!validateEmail(email)) {
            alert("올바른 이메일 주소를 입력하세요.");
            return;
        }
        if (!emailCode) {
            alert("이메일 인증 코드를 입력해주세요.");
            return;
        }
        if (!memberId) {
            alert("아이디를 입력해주세요.");
            return;
        }

        // 중복 확인 후에 진행
        fetch(`/signup/check-id?memberId=${encodeURIComponent(memberId)}`)
            .then(response => response.json())
            .then(data => {
                // 비밀번호, 주소, 전화번호 유효성 검사를 진행
                if (!password) {
                    alert("비밀번호를 입력해주세요.");
                    return;
                }
                if (!confirmPassword) {
                    alert("비밀번호 확인을 입력해주세요.");
                    return;
                }
                if (password !== confirmPassword) {
                    alert("비밀번호가 일치하지 않습니다.");
                    return;
                }
                if (!address) {
                    alert("주소를 입력해주세요.");
                    return;
                }
                if (!phone) {
                    alert("전화번호를 입력해주세요.");
                    return;
                }
                if (!validatePhone(phone)) {
                    alert("올바른 전화번호를 입력하세요. (예: 010-1234-5678)");
                    return;
                }

                alert("회원가입이 완료되었습니다!");
            })
            .catch(error => {
                console.error("오류 발생:", error);
                alert("아이디 중복 검사에 실패했습니다.");
            });
    });

    // 이메일 인증 코드 전송 버튼 이벤트
    document.querySelector('.verify-btn').addEventListener('click', function () {
        const email = document.getElementById('email').value.trim();

        if (!email) {
            alert("이메일을 입력해주세요.");
            return;
        }
        if (!validateEmail(email)) {
            alert("올바른 이메일 주소를 입력하세요.");
            return;
        }

        fetch('/signup/send-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
            .then(response => response.text())
            .then(data => {
                alert("인증 코드가 이메일로 전송되었습니다.");
                console.log("서버 응답:", data);
            })
            .catch(error => {
                console.error("오류 발생:", error);
                alert("이메일 전송 실패");
            });
    });

    // 이메일 유효성 검사 함수
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // 전화번호 유효성 검사 함수
    function validatePhone(phone) {
        const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
        return phoneRegex.test(phone);
    };

    // 중복 확인 버튼 이벤트
    function checkDuplicate() {
        const memberId = document.getElementById("memberId").value;

        // 아이디가 비어있지 않으면 Ajax 요청
        if (memberId) {
            fetch(`/check-duplicate?id=${memberId}`)
                .then(response => {
                    if (response.ok) {
                        return response.text(); // 서버에서 성공적인 응답을 받으면 메시지 반환
                    } else {
                        throw new Error('중복된 아이디입니다.'); // 중복된 경우 오류 메시지
                    }
                })
                .then(message => {
                    alert("사용 가능한 아이디입니다."); // 중복되지 않은 ID일 경우
                })
                .catch(error => {
                    alert(error.message); // 중복된 ID일 경우
                });
        } else {
            alert("아이디를 입력해주세요.");
        }
    }
</script>

<style>
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .input-group input {
        flex: 1;
    }
    .hidden {
        display: none;
    }
</style>

</body>
</html>